name: Build
on: [push, pull_request]
# TODO: Can we split things up in a more intutive way?
# i.e. an "Android" job which does the android/java linting and build
# an iOS job which does the swift/ios linting and build
# a JS/CLI job which does the js linting (and cli tests?)
# a packaging job which generates the combined SDK from ios/Android?

jobs:
  android:
    runs-on: ubuntu-latest
    name: Android
    steps:
    - uses: actions/checkout@v2

    - name: Use Node.js 12.x
      uses: actions/setup-node@v1
      with:
        node-version: '12.x'

    - name: Cache Node.js modules
      id: node-cache
      uses: actions/cache@v2
      with:
        path: node_modules
        key: ${{ runner.OS }}-node-modules-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.OS }}-node-modules-
          ${{ runner.OS }}-

    - run: npm ci
      name: Install dependencies
      if: steps.node-cache.outputs.cache-hit != 'true'

    - name: Cache Gradle packages
      uses: actions/cache@v2
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - run: npm run lint:android
      name: Lint

# TODO: Build the android half here and stash/upload the built stuff:
# - dist/android/titanium.bindings.json
# - android/titanium/build/outputs
# - android/runtime/v8/generated
# - dist/android/libv8
#  Or do we run build *and* publish and then copy over the resulting stuff from each platform and piece them together?
# Because I assume there's some intermediate files from gradle/cmake/ndk that'd be missing to separet the build/publish halves

    - name: Cleanup Gradle Cache
      # Remove some files from the Gradle cache, so they aren't cached by GitHub Actions.
      # Restoring these files from a GitHub Actions cache might cause problems for future builds.
      run: |
        rm -f ~/.gradle/caches/modules-2/modules-2.lock
        rm -f ~/.gradle/caches/modules-2/gc.properties

  ios:
    runs-on: macos-latest
    name: iOS
    steps:
    - uses: actions/checkout@v2

    - name: Create version tag
      run: |
        PACKAGE_VERSION=$(sed -n 's/^ *"version": *"//p' package.json | tr -d '"' | tr -d ',' | tr -d '[[:space:]]')
        TIMESTAMP=`date +'%Y%m%d%H%M%S'`
        VTAG="${PACKAGE_VERSION}.v${TIMESTAMP}"
        echo "vtag=${VTAG}" >> $GITHUB_ENV

    - name: Use Node.js 12.x
      uses: actions/setup-node@v1
      with:
        node-version: '12.x'

    - name: Cache Node.js modules
      id: node-cache
      uses: actions/cache@v2
      with:
        path: node_modules
        key: ${{ runner.OS }}-node-modules-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.OS }}-node-modules-
          ${{ runner.OS }}-

    - run: npm ci
      name: Install dependencies
      if: steps.node-cache.outputs.cache-hit != 'true'

# TODO: Cache the v8 library for android builds? dist/android/libv8/**

    - name: Cache Gradle packages
      uses: actions/cache@v2
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - run: npm run lint:ios
      name: Lint

    - name: Install packages for macOS
      if: matrix.os == 'macos-latest'
      run: brew install ccache

    - run: npm run build -- --all
      name: Build

    - name: Show summary of ccache configuration and statistics counters
      run: ccache --show-stats

    - run: npm run package -- --version-tag ${{ env.vtag }} --all
      name: Package

    - name: Archive OSX artifact
      uses: actions/upload-artifact@v2
      with:
        name: mobilesdk-osx.zip
        path: |
          dist/mobilesdk-*-osx.zip

    - name: Archive win32 artifact
      uses: actions/upload-artifact@v2
      with:
        name: mobilesdk-win32.zip
        path: |
          dist/mobilesdk-*-win32.zip

    # - name: Archive Linux artifact
    #   uses: actions/upload-artifact@v2
    #   with:
    #     name: mobilesdk-linux.zip
    #     path: |
    #       dist/mobilesdk-*-linux.zip

    - name: Cleanup Gradle Cache
      # Remove some files from the Gradle cache, so they aren't cached by GitHub Actions.
      # Restoring these files from a GitHub Actions cache might cause problems for future builds.
      run: |
        rm -f ~/.gradle/caches/modules-2/modules-2.lock
        rm -f ~/.gradle/caches/modules-2/gc.properties

  js:
    runs-on: ubuntu-latest
    name: JavaScript
    steps:
    - uses: actions/checkout@v2

    - name: Use Node.js 12.x
      uses: actions/setup-node@v1
      with:
        node-version: '12.x'

    - name: Cache Node.js modules
      id: node-cache
      uses: actions/cache@v2
      with:
        path: node_modules
        key: ${{ runner.OS }}-node-modules-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.OS }}-node-modules-
          ${{ runner.OS }}-

    - run: npm ci
      name: Install dependencies
      if: steps.node-cache.outputs.cache-hit != 'true'

    - run: npm run lint:js
      name: Lint